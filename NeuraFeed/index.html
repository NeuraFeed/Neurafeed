<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuraFeed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-tertiary: #6c757d;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --focus-ring-color: #3b82f6;
            --player-bg: #ffffff;
            --overlay-color-start: rgba(0,0,0,0.2);
            --overlay-color-end: rgba(0,0,0,0.8);
            --player-text-primary: #ffffff;
            --player-text-secondary: rgba(255,255,255,0.8);
        }

        body.dark {
            --bg-primary: #0a0a0a;
            --bg-secondary: #121212;
            --border-color: #272727;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-tertiary: #737373;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --player-bg: #181818;
            --overlay-color-start: rgba(0,0,0,0.3);
            --overlay-color-end: rgba(0,0,0,0.9);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            background-color: var(--bg-secondary);
        }
        
        .header-logo-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-placeholder {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Roboto Mono', monospace;
            font-weight: 600;
            color: var(--text-tertiary);
        }
        
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .app-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #theme-switcher {
            background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%;
            color: var(--text-secondary); transition: background-color 0.2s;
        }
        #theme-switcher:hover { background-color: var(--border-color); }
        #theme-switcher svg { width: 1.5rem; height: 1.5rem; }
        
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* Mobile First: Stack player and chat */
            overflow: hidden;
        }

        #player-container {
            width: 100%;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow: hidden;
        }

        #player-card {
            width: 100%;
            height: 100%;
            background-color: var(--player-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 10px 25px var(--shadow-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }

        .card-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, var(--overlay-color-start) 0%, var(--overlay-color-end) 80%);
            display: flex; flex-direction: column;
        }
        
        #article-text-container {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        #article-headline {
            font-size: 1.75rem; font-weight: 700; line-height: 1.25; margin-bottom: 1.5rem;
            color: var(--player-text-primary); text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        #article-short-summary {
            font-size: 1.1rem; line-height: 1.8; color: var(--player-text-secondary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); margin-bottom: 2rem;
        }
        #article-short-summary strong { color: var(--player-text-primary); font-weight: 600; }
        
        #source-info {
            font-size: 0.875rem; color: rgba(255,255,255,0.6); padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        #source-info a { color: #529dff; text-decoration: none; font-weight: 500; }
        #source-info a:hover { text-decoration: underline; }

        #player-controls {
            padding: 1rem;
            flex-shrink: 0;
        }
        .controls-top {
            display: flex; align-items: center; justify-content: center;
            gap: 1.5rem; margin-bottom: 0.75rem;
        }
        .control-button {
            background: none; border: none; cursor: pointer; color: var(--player-text-secondary);
            padding: 0.5rem; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; transition: background-color 0.2s, color 0.2s;
        }
        .control-button:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--player-text-primary);
        }
        .control-button:disabled { color: rgba(255,255,255,0.3); cursor: not-allowed; }
        .control-button svg { width: 1.5rem; height: 1.5rem; }
        #play-pause-button svg { width: 2.5rem; height: 2.5rem; }
        
        #progress-bar-container {
            width: 100%; height: 4px; background-color: rgba(255,255,255,0.2);
            border-radius: 2px; cursor: pointer;
        }
        #progress-bar {
            width: 0%; height: 100%; background-color: var(--player-text-primary);
            border-radius: 2px;
        }

        .volume-control-container { position: relative; }
        #volume-slider-popup {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: var(--player-bg); border: 1px solid var(--border-color);
            border-radius: 0.5rem; padding: 1rem 0.5rem; margin-bottom: 0.5rem;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 8px; height: 100px; background: var(--border-color);
            outline: none; border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; background: var(--text-tertiary);
            cursor: pointer; border-radius: 50%;
        }

        #chat-sidebar {
            width: 100%;
            height: 50vh; 
            max-width: 100%;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        #chat-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; font-weight: 600; font-size: 1.125rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        #chat-messages {
            flex-grow: 1; padding: 1rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .chat-message { padding: 0.75rem 1rem; border-radius: 0.75rem; max-width: 80%; word-wrap: break-word; }
        .user-message {
            background-color: #3b82f6; color: white;
            align-self: flex-end; border-bottom-right-radius: 0.25rem;
        }
        .model-message {
            background-color: var(--bg-primary); border: 1px solid var(--border-color);
            align-self: flex-start; border-bottom-left-radius: 0.25rem;
        }
        #chat-form { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); }
        #chat-input {
            flex-grow: 1; background-color: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 9999px; padding: 0.75rem 1rem; color: var(--text-primary);
        }
        #chat-send { background: none; border: none; cursor: pointer; padding: 0.5rem; color: #3b82f6; margin-left: 0.5rem; }

        .hidden { display: none; }
        .dark #icon-sun { display: block; } .dark #icon-moon { display: none; } #icon-sun { display: none; }

        :focus-visible { outline: 2px solid var(--focus-ring-color); outline-offset: 2px; border-radius: 4px; }
        
        @media (min-width: 1024px) {
            main { flex-direction: row; }
            #player-container { padding: 2rem; width: 66.6667%;}
            #chat-sidebar { 
                width: 33.3333%; height: 100%; max-width: 400px; 
                border-top: none; border-left: 1px solid var(--border-color);
            }
            #article-text-container { padding: 2.5rem; }
            #article-headline { font-size: 2.5rem; }
            #article-short-summary { font-size: 1.25rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-logo-group">
                <div class="logo-placeholder" title="NeuraFeed Logo">NF</div>
                <span class="app-title">NeuraFeed</span>
            </div>
            <nav class="app-menu" aria-label="Hauptmenü">
                <button id="theme-switcher" aria-label="Helles oder dunkles Design auswählen" title="Helles/Dunkles Design umschalten">
                    <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21c3.736 0 7.09-1.842 9.002-4.634z" /></svg>
                    <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                </button>
            </nav>
        </header>

        <main>
            <div id="player-container">
                <article id="player-card">
                    <div class="card-overlay">
                        <div id="article-text-container">
                            <h1 id="article-headline">Willkommen bei NeuraFeed</h1>
                            <p id="article-short-summary">Drücke auf Play, um mit den neuesten Nachrichten zu starten.</p>
                            <div id="source-info"></div>
                        </div>
                         <div id="player-controls">
                             <div style="width: 100%;">
                                 <div class="controls-top">
                                     <button class="control-button" id="prev-button" aria-label="Zum vorherigen Artikel" title="Zum vorherigen Artikel">
                                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 16.811c0 .864-.933 1.405-1.683.977l-7.108-4.062a1.125 1.125 0 010-1.953l7.108-4.062A1.125 1.125 0 0121 8.189v8.622zM3 8.189v8.622c0 .621.504 1.125 1.125 1.125h1.5c.621 0 1.125-.504 1.125-1.125V8.189c0-.621-.504-1.125-1.125-1.125h-1.5A1.125 1.125 0 003 8.189z" /></svg>
                                     </button>
                                     <button class="control-button" id="play-pause-button" aria-label="Abspielen oder pausieren" title="Abspielen oder pausieren">
                                         <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z" /></svg>
                                         <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9v6m-4.5 0V9M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                     </button>
                                     <button class="control-button" id="next-button" aria-label="Zum nächsten Artikel" title="Zum nächsten Artikel">
                                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.811V7.189a1.125 1.125 0 011.683-.977l7.108 4.062a1.125 1.125 0 010 1.954l-7.108 4.062A1.125 1.125 0 013 16.811zM21 7.189v9.622a1.125 1.125 0 01-1.125 1.125h-1.5a1.125 1.125 0 01-1.125-1.125V7.189a1.125 1.125 0 011.125-1.125h1.5A1.125 1.125 0 0121 7.189z" /></svg>
                                     </button>
                                      <div class="volume-control-container">
                                          <button class="control-button" id="volume-button" aria-label="Lautstärke ändern" title="Lautstärke ändern">
                                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                         </button>
                                         <div id="volume-slider-popup" class="hidden">
                                              <input type="range" min="0" max="1" step="0.01" value="1" orient="vertical">
                                         </div>
                                     </div>
                                 </div>
                                  <div id="progress-bar-container">
                                     <div id="progress-bar"></div>
                                  </div>
                             </div>
                         </div>
                    </div>
                </article>
            </div>
            <aside id="chat-sidebar">
                 <div id="chat-header">
                     <span>Fragen zum Artikel</span>
                     <button id="reset-chat-button" aria-label="Chat zurücksetzen" title="Chat zurücksetzen" class="control-button" style="color: var(--text-secondary);">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.812-2.332M3.98 8.223l3.181-3.182a8.25 8.25 0 0111.812 2.332M9 12.013v.001" /></svg>
                     </button>
                 </div>
                 <div id="chat-messages"></div>
                 <form id="chat-form">
                     <input id="chat-input" type="text" placeholder="Ihre Frage..." autocomplete="off">
                     <button id="chat-send" aria-label="Frage senden">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                     </button>
                 </form>
            </aside>
        </main>
    </div>

    <script type="module">
        // --- Theme Switcher Logic ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const body = document.body;

        const applyTheme = (theme) => {
            if (theme === 'dark') body.classList.add('dark');
            else body.classList.remove('dark');
        };

        themeSwitcher.addEventListener('click', () => {
            const newTheme = body.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
        
        // --- DOM Elements ---
        const playerCard = document.getElementById('player-card');
        const articleHeadline = document.getElementById('article-headline');
        const articleShortSummary = document.getElementById('article-short-summary');
        const prevButton = document.getElementById('prev-button');
        const playPauseButton = document.getElementById('play-pause-button');
        const nextButton = document.getElementById('next-button');
        const playIcon = document.getElementById('icon-play');
        const pauseIcon = document.getElementById('icon-pause');
        const progressBar = document.getElementById('progress-bar');
        const sourceInfo = document.getElementById('source-info');
        const volumeButton = document.getElementById('volume-button');
        const volumeSliderPopup = document.getElementById('volume-slider-popup');
        const volumeSlider = volumeSliderPopup.querySelector('input');
        const chatSidebar = document.getElementById('chat-sidebar');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const resetChatButton = document.getElementById('reset-chat-button');
        
        // --- State Management ---
        let articlesCache = [];
        let currentArticleIndex = 0;
        let isFetching = false;
        let audioPlayer = new Audio();
        let longSummaryForTTS = "";
        const synth = window.speechSynthesis;
        let germanVoice = null;

        // --- FIX for Preview Environment ---
        // When running locally or in a preview, /.netlify/... is not a valid path.
        // We detect if we are on a "real" domain or in a local/preview environment.
        const isLive = window.location.hostname.includes('netlify.app') || window.location.hostname.includes('.');
        const functionsPath = isLive ? '/.netlify/functions' : 'https://jsonplaceholder.typicode.com';
        
        // --- Main App Logic ---
        async function initializeApp() {
            const today = new Date().toISOString().split('T')[0];
            const cachedData = localStorage.getItem('newsCache');
            if (cachedData) {
                const cache = JSON.parse(cachedData);
                if (cache.date === today && cache.articles.length > 0) articlesCache = cache.articles;
            }
            if (articlesCache.length === 0) await populateArticleCache();
            
            if (articlesCache.length > 0) {
                await displayArticle(currentArticleIndex, false);
            } else {
                 articleHeadline.textContent = "Keine Nachrichten gefunden";
                 articleShortSummary.innerHTML = "Es konnten keine aktuellen Nachrichten geladen werden. Bitte versuchen Sie es später erneut.";
                 playPauseButton.disabled = true;
                 nextButton.disabled = true;
                 prevButton.disabled = true;
            }
        }

        async function populateArticleCache() {
            isFetching = true;
            articleHeadline.textContent = "Lade Nachrichten des Tages...";
            articleShortSummary.innerHTML = "";
            
            try {
                // The URL is now dynamic: it points to Netlify functions if live, or a mock API for local/preview.
                const apiUrl = isLive ? `${functionsPath}/get-news` : `${functionsPath}/posts?_limit=10`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
                const data = await response.json();

                // Adapt data based on the source (Live Netlify Function vs. Mock API)
                let articles;
                if (isLive) {
                    articles = data.articles; // Data from our GNews function
                } else {
                    // Adapt mock data from jsonplaceholder to our format
                    articles = data.map(post => ({
                        title: post.title.charAt(0).toUpperCase() + post.title.slice(1),
                        description: post.body,
                        url: '#',
                        image: `https://placehold.co/800x450/3B82F6/FFFFFF?text=Artikel+${post.id}`,
                        publishedAt: new Date().toISOString(),
                        source: { name: 'MockAPI' }
                    }));
                }

                if (articles && articles.length > 0) {
                    const cache = { date: new Date().toISOString().split('T')[0], articles: articles };
                    localStorage.setItem('newsCache', JSON.stringify(cache));
                    articlesCache = articles;
                } else { throw new Error("No articles found from API."); }
            } catch (error) {
                console.error(`Error populating cache:`, error);
                articleHeadline.textContent = "Fehler beim Laden der Nachrichten.";
                articleShortSummary.innerHTML = "Die Verbindung zum Nachrichten-Server konnte nicht hergestellt werden. Bitte versuchen Sie es später erneut.";
            } finally { isFetching = false; }
        }

        async function displayArticle(index, analyze = true) {
            if (isFetching || index < 0 || index >= articlesCache.length) return;
            const article = articlesCache[index];
            
            resetPlayer();
            
            playerCard.style.backgroundImage = `url(${article.image || `https://placehold.co/800x450/f1f3f5/6c757d?text=Kein+Bild`})`;
            updateSourceInfo(article.publishedAt, article.source.name, article.url);
            
            currentArticleIndex = index;
            prevButton.disabled = index === 0;
            nextButton.disabled = index === articlesCache.length - 1;
            
            if (analyze) {
                 articleHeadline.textContent = "Analysiere & erweitere Artikel...";
                 articleShortSummary.innerHTML = "Bitte einen Moment Geduld...";
                
                 const metrics = await analyzeText(article.title, article.description);
                 
                 articleHeadline.textContent = metrics?.ueberschrift || article.title;
                 longSummaryForTTS = metrics?.lange_zusammenfassung || article.description || "";
                 let shortSummary = metrics?.kurze_zusammenfassung || longSummaryForTTS;

                 if (shortSummary && metrics?.schlagwoerter) {
                     metrics.schlagwoerter.forEach(word => {
                         const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                         shortSummary = shortSummary.replace(regex, '<strong>$1</strong>');
                     });
                 }
                 articleShortSummary.innerHTML = shortSummary;
            } else {
                articleHeadline.textContent = article.title;
                articleShortSummary.innerHTML = article.description;
                longSummaryForTTS = article.description || "";
            }
        }
        
        async function analyzeText(title, description) {
            if (!isLive) {
                // In preview mode, return a mock response to avoid errors.
                await new Promise(resolve => setTimeout(resolve, 1000));
                return {
                    ueberschrift: `KI-Analyse: ${title}`,
                    kurze_zusammenfassung: `Dies ist eine <strong>KI-generierte</strong> Kurzzusammenfassung. Der Kern des Artikels dreht sich um <strong>relevante</strong> Inhalte, die für den <strong>Leser</strong> von Interesse sind.`,
                    lange_zusammenfassung: `Die simulierte lange Zusammenfassung geht hier tiefer ins Detail. Sie erläutert die verschiedenen Aspekte des Themas und bietet einen umfassenderen Überblick, der für die Sprachausgabe geeignet ist.`,
                    schlagwoerter: ["KI-generierte", "relevante", "Leser"]
                };
            }
            try {
                // This part runs only when the site is live on Netlify
                const response = await fetch(`${functionsPath}/summarize`, { 
                    method: 'POST',
                    body: JSON.stringify({ title, description })
                });
                if (!response.ok) throw new Error('Backend summarization failed.');
                return await response.json();
            } catch (error) {
                console.error("Error calling summarization function:", error);
                addMessage("Die KI-Analyse des Artikels ist fehlgeschlagen.", "model");
                return null;
            }
        }
        
        async function getPremiumAudio(text) {
             if (!text) return null;
             console.warn("Premium TTS function not implemented. Falling back to browser speech synthesis.");
             return null; 
        }
        
        function updateSourceInfo(date, name, link) {
            const formattedDate = new Date(date).toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' });
            sourceInfo.innerHTML = `${formattedDate} &bull; ${name} &bull; <a href="${link}" target="_blank" rel="noopener noreferrer">Originalartikel anzeigen</a>`;
        }
        
        function resetPlayer() {
            audioPlayer.pause();
            audioPlayer.src = "";
            if(synth) synth.cancel();
            progressBar.style.width = '0%';
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        }

        async function playCurrentArticle() {
            if (isFetching) return;
            
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            
            const textToSpeak = `${articleHeadline.textContent}. ${longSummaryForTTS}`;
            const audioContent = await getPremiumAudio(textToSpeak);
            
            if (audioContent) {
                audioPlayer.src = `data:audio/mp3;base64,${audioContent}`;
                audioPlayer.play();
            } else {
                playWithBrowserTTS(textToSpeak);
            }
        }

        function playWithBrowserTTS(text) {
            if (synth.speaking) synth.cancel();

            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'de-DE';
                utterance.volume = audioPlayer.volume;
                if (germanVoice) utterance.voice = germanVoice;

                let timer;
                utterance.onstart = () => {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    let lastTime = 0;
                    timer = setInterval(() => {
                        lastTime += 100;
                        const estimatedDuration = text.length * 60;
                        const progress = (lastTime / estimatedDuration) * 100;
                        progressBar.style.width = `${Math.min(progress, 100)}%`;
                    }, 100);
                };

                utterance.onend = () => {
                    clearInterval(timer);
                    progressBar.style.width = '100%';
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    handleAutoPlayNext();
                };

                 utterance.onerror = (event) => {
                    clearInterval(timer);
                    console.error("Browser TTS failed:", event.error);
                    addMessage("Sprachausgabe fehlgeschlagen. Ihr Browser unterstützt möglicherweise keine deutsche Sprachausgabe.", 'model');
                    resetPlayer();
                };
                
                synth.speak(utterance);
            }, 250);
        }
        
        function handleAutoPlayNext() {
            if (currentArticleIndex < articlesCache.length - 1) {
                displayArticle(currentArticleIndex + 1).then(playCurrentArticle);
            } else {
                resetPlayer();
            }
        }

        playPauseButton.addEventListener('click', () => {
            if (synth.speaking) {
                synth.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                return;
            }
            if (synth.paused) {
                synth.resume();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                return;
            }

            if (!audioPlayer.src && !synth.speaking) {
                 playCurrentArticle();
                 return;
            }
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        });

        nextButton.addEventListener('click', () => {
            if (currentArticleIndex < articlesCache.length - 1) {
                displayArticle(currentArticleIndex + 1).then(playCurrentArticle);
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentArticleIndex > 0) {
                displayArticle(currentArticleIndex - 1).then(playCurrentArticle);
            }
        });
        
        audioPlayer.onplay = () => {
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
        };
        audioPlayer.onpause = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        };

        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = `${progress}%`;
            }
        });

        audioPlayer.addEventListener('ended', handleAutoPlayNext);
        
        volumeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            volumeSliderPopup.classList.toggle('hidden');
        });
        
        volumeSlider.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value;
        });
        
        document.addEventListener('click', (e) => {
            if (volumeSliderPopup && !volumeSliderPopup.contains(e.target) && !volumeButton.contains(e.target)) {
                volumeSliderPopup.classList.add('hidden');
            }
        });
        
        // --- Chat Logic ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessage(userMessage, 'user');
            chatInput.value = '';
            
            const currentArticle = articlesCache[currentArticleIndex];
            const context = `Artikel: "${currentArticle.title}. ${longSummaryForTTS || currentArticle.description}"`;
            
            addMessage("KI denkt nach...", 'model', true);
            const responseText = await getChatResponse(context, userMessage);
            updateLastModelMessage(responseText);
        });

        resetChatButton.addEventListener('click', () => {
            chatMessages.innerHTML = '';
        });

        async function getChatResponse(context, userMessage) {
             if (!isLive) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (userMessage.toLowerCase().includes("berlin")) {
                     return "Ja, der Artikel erwähnt, dass die Forscher, die das KI-System entwickelt haben, aus Berlin stammen.";
                 } else {
                     return "Diese Information ist nicht direkt in dem Artikel enthalten. Eine allgemeine Recherche ergibt, dass KI in der Medizin ein schnell wachsendes Feld mit vielen ethischen Diskussionen ist.";
                 }
            }
            try {
                // NETLIFY: Calling our secure chat function
                const response = await fetch(`${functionsPath}/chat`, { 
                    method: 'POST',
                    body: JSON.stringify({ context, userMessage })
                });
                if (!response.ok) throw new Error('Backend chat function failed.');
                const data = await response.json();
                return data.text;
            } catch (error) {
                console.error("Error in getChatResponse:", error)
                return "Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.";
            }
        }
        
        function addMessage(text, role, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            if (isLoading) {
                messageDiv.id = 'loading-message';
                messageDiv.innerHTML = `<span class="italic">${text}</span>`;
            } else {
                messageDiv.textContent = text;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateLastModelMessage(text) {
              const loadingMessage = document.getElementById('loading-message');
              if (loadingMessage) {
                  loadingMessage.textContent = text;
                  loadingMessage.removeAttribute('id');
              }
        }
        
        function initializeTTS() {
            function findGermanVoice() {
                germanVoice = synth.getVoices().find(voice => voice.lang === 'de-DE');
            }
            synth.onvoiceschanged = findGermanVoice;
            findGermanVoice();
        }

        // --- Start ---
        initializeApp();
        initializeTTS();
    </script>
</body>
</html>
